#cloud-config
# GitHub Actions Self-Hosted Runner Cloud-Init
# =============================================
# Variant: ${variant}
# Description: ${description}

hostname: ${runner_name}
manage_etc_hosts: true

# Install packages
packages:
%{ for pkg in packages ~}
  - ${pkg}
%{ endfor ~}

# Create runner user
users:
  - name: runner
    gecos: GitHub Actions Runner
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: docker,wheel
    shell: /bin/bash
    lock_passwd: true

# Write configuration files
write_files:
  # Runner configuration script
  - path: /opt/actions-runner/configure-runner.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      
      RUNNER_DIR="/opt/actions-runner"
      RUNNER_NAME="${runner_name}"
      RUNNER_LABELS="${runner_labels}"
      GITHUB_REPO="${github_repo}"
      
      cd "$RUNNER_DIR"
      
      # Get registration token from PAT if needed
      if [[ "$${GITHUB_TOKEN:-}" =~ ^ghp_ ]]; then
        # It's a PAT, get a registration token
        REG_TOKEN=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/$GITHUB_REPO/actions/runners/registration-token" \
          | jq -r '.token')
      else
        # Assume it's already a registration token
        REG_TOKEN="$GITHUB_TOKEN"
      fi
      
      if [[ -z "$REG_TOKEN" || "$REG_TOKEN" == "null" ]]; then
        echo "ERROR: Failed to get registration token"
        exit 1
      fi
      
      # Configure the runner
      ./config.sh \
        --url "https://github.com/$GITHUB_REPO" \
        --token "$REG_TOKEN" \
        --name "$RUNNER_NAME" \
        --labels "$RUNNER_LABELS" \
        --work "_work" \
        --unattended \
        --replace
      
      echo "Runner configured successfully"
  
  # Runner service file
  - path: /etc/init.d/github-runner
    permissions: '0755'
    content: |
      #!/sbin/openrc-run
      
      name="github-runner"
      description="GitHub Actions Runner"
      command="/opt/actions-runner/run.sh"
      command_background="yes"
      pidfile="/run/$${RC_SVCNAME}.pid"
      user="runner"
      group="runner"
      directory="/opt/actions-runner"
      
      depend() {
        need net
        after docker
      }
      
      start_pre() {
        checkpath -d -o runner:runner /opt/actions-runner/_work
      }
  
  # Variant info
  - path: /etc/infrasim/runner-variant
    permissions: '0644'
    content: |
      VARIANT=${variant}
      RUNNER_NAME=${runner_name}
      RUNNER_LABELS=${runner_labels}
      DESCRIPTION=${description}

# Run commands
runcmd:
  # Create runner directory
  - mkdir -p /opt/actions-runner
  - chown -R runner:runner /opt/actions-runner
  
  # Download GitHub Actions runner
  - |
    cd /opt/actions-runner
    RUNNER_VERSION="${runner_version}"
    RUNNER_ARCH=$(uname -m)
    
    case "$RUNNER_ARCH" in
      x86_64) RUNNER_ARCH="x64" ;;
      aarch64) RUNNER_ARCH="arm64" ;;
    esac
    
    curl -L -o actions-runner.tar.gz \
      "https://github.com/actions/runner/releases/download/v$${RUNNER_VERSION}/actions-runner-linux-$${RUNNER_ARCH}-$${RUNNER_VERSION}.tar.gz"
    
    tar -xzf actions-runner.tar.gz
    rm actions-runner.tar.gz
    
    chown -R runner:runner /opt/actions-runner
  
  # Install dependencies
  - /opt/actions-runner/bin/installdependencies.sh || true
  
  # Configure runner
  - |
    export GITHUB_TOKEN="${github_token}"
    su - runner -c "/opt/actions-runner/configure-runner.sh"
  
  # Start Docker
  - rc-update add docker default
  - rc-service docker start || true
  
  # Start runner service
  - rc-update add github-runner default
  - rc-service github-runner start
  
  # Signal ready
  - echo "RUNNER_READY name=${runner_name} variant=${variant}" > /dev/ttyS0
  - echo "RUNNER_READY" >> /var/log/runner-status.log

final_message: "GitHub Actions runner ${runner_name} (${variant}) ready."
