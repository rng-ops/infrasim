# ============================================================================
# Docker Compose for Secure GitHub Actions Runner
# ============================================================================
#
# This runs the GitHub Actions runner inside a proper Docker container
# with HashiCorp Vault for secrets management. No paravirtualization,
# no chroot jails - full container isolation.
#
# Usage:
#   cd scripts/runner
#   docker compose up -d
#
# Components:
#   - vault: HashiCorp Vault for secrets (GITHUB_TOKEN, etc.)
#   - runner: GitHub Actions runner in Docker-in-Docker mode
#

services:
  # ===========================================================================
  # HashiCorp Vault - Secrets Management
  # ===========================================================================
  vault:
    image: hashicorp/vault:1.15
    container_name: infrasim-vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    ports:
      - "8201:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "infrasim-dev-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://127.0.0.1:8200"
    volumes:
      - vault-data:/vault/data
    command: server -dev
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - infrasim-net

  # ===========================================================================
  # GitHub Actions Runner - Containerized
  # ===========================================================================
  runner:
    build:
      context: .
      dockerfile: Dockerfile.runner
    container_name: infrasim-runner
    restart: unless-stopped
    depends_on:
      vault:
        condition: service_healthy
    privileged: true  # Required for Docker-in-Docker
    environment:
      # Vault configuration
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "infrasim-dev-token"
      
      # Runner configuration (secrets fetched from Vault at runtime)
      GITHUB_ORG: "rng-ops"
      GITHUB_REPO: "infrasim"
      RUNNER_NAME: "infrasim-docker-runner"
      RUNNER_LABELS: "self-hosted,Linux,ARM64,docker,secure"
      RUNNER_WORKDIR: "/runner/_work"
    volumes:
      # Docker-in-Docker socket
      - /var/run/docker.sock:/var/run/docker.sock
      # Persistent runner data
      - runner-data:/runner
      # Build cache
      - runner-cache:/home/runner/.cache
    networks:
      - infrasim-net

  # ===========================================================================
  # Alpine Builder - For image builds
  # ===========================================================================
  builder:
    build:
      context: ../../images/alpine
      dockerfile: Dockerfile.builder
    container_name: infrasim-builder
    profiles:
      - build  # Only start when explicitly requested
    privileged: true
    volumes:
      - ../../:/workspace:rw
    working_dir: /workspace/images/alpine
    networks:
      - infrasim-net

volumes:
  vault-data:
  runner-data:
  runner-cache:

networks:
  infrasim-net:
    driver: bridge
