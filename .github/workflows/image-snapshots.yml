# ============================================================================
# image-snapshots.yml - Build Image Snapshots with InfraSim Provenance
# ============================================================================
#
# Creates versioned qcow2 image snapshots with full build provenance:
# - InfraSim version hash pinned to each image
# - Dependency graph analysis for supply chain visibility
# - Automatic tagging on successful builds
#
# Triggers:
# - Tag push (v*) - Creates a release with the image bundle
# - Push to main with image changes - Creates snapshot and tags
# - Weekly schedule - Creates a rolling nightly snapshot
# - Manual dispatch - For testing/ad-hoc builds
#
name: Image Snapshots

on:
  push:
    branches: [main]
    paths:
      - 'images/**'
      - 'ci/bundle_qcow2.sh'
      - '.github/workflows/image-snapshots.yml'
    tags:
      - 'v*'
      - 'image-*'
  schedule:
    # Every Sunday at 2 AM UTC - rolling weekly snapshot
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      snapshot_type:
        description: 'Snapshot type'
        type: choice
        options:
          - release
          - nightly
          - test
        default: test
      alpine_version:
        description: 'Alpine version'
        default: '3.20'
      create_tag:
        description: 'Create git tag on success'
        type: boolean
        default: true
      image_type:
        description: 'Image type to build'
        type: choice
        options:
          - alpine
          - kali-xfce-vnc
          - all
        default: alpine

env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}
  CARGO_TERM_COLOR: always

jobs:
  # ===========================================================================
  # Build InfraSim and Analyze Dependencies
  # ===========================================================================
  build-infrasim:
    name: Build InfraSim & Analyze
    runs-on: ubuntu-latest
    outputs:
      infrasim_version: ${{ steps.build.outputs.version }}
      infrasim_sha256: ${{ steps.build.outputs.sha256 }}
      dep_graph_sha256: ${{ steps.analyze.outputs.graph_sha256 }}
      risk_score: ${{ steps.analyze.outputs.risk_score }}
      cycle_count: ${{ steps.analyze.outputs.cycle_count }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install protobuf
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler
    
    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build InfraSim
      id: build
      run: |
        cargo build --release --all
        
        # Compute version info
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev-$(git rev-parse --short HEAD)")
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        
        # Compute binary hashes
        DAEMON_SHA256=$(sha256sum target/release/infrasimd | awk '{print $1}')
        CLI_SHA256=$(sha256sum target/release/infrasim | awk '{print $1}')
        echo "sha256=${DAEMON_SHA256}" >> $GITHUB_OUTPUT
        echo "cli_sha256=${CLI_SHA256}" >> $GITHUB_OUTPUT
    
    - name: Run dependency analysis
      id: analyze
      run: |
        # Run cargo metadata for dependency graph
        cargo metadata --format-version 1 --all-features > cargo-metadata.json
        
        # Compute graph hash for provenance
        GRAPH_SHA256=$(sha256sum cargo-metadata.json | awk '{print $1}')
        echo "graph_sha256=${GRAPH_SHA256}" >> $GITHUB_OUTPUT
        
        # Extract stats from metadata
        PACKAGE_COUNT=$(jq '.packages | length' cargo-metadata.json)
        echo "package_count=${PACKAGE_COUNT}" >> $GITHUB_OUTPUT
        
        # Simple cycle/risk detection via cargo tree
        if cargo tree --duplicates 2>/dev/null | grep -q "^"; then
          echo "has_duplicates=true" >> $GITHUB_OUTPUT
        else
          echo "has_duplicates=false" >> $GITHUB_OUTPUT
        fi
        
        # Placeholder for full analysis (would use infrasim CLI)
        echo "risk_score=0" >> $GITHUB_OUTPUT
        echo "cycle_count=0" >> $GITHUB_OUTPUT
    
    - name: Create provenance attestation
      run: |
        mkdir -p provenance
        
        cat > provenance/infrasim-build.json << EOF
        {
          "version": "${{ steps.build.outputs.version }}",
          "git_commit": "${{ github.sha }}",
          "git_ref": "${{ github.ref }}",
          "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "github_run_id": "${{ github.run_id }}",
          "github_run_number": "${{ github.run_number }}",
          "runner_os": "${{ runner.os }}",
          "rust_version": "$(rustc --version)",
          "cargo_version": "$(cargo --version)",
          "binaries": {
            "infrasimd": {
              "sha256": "${{ steps.build.outputs.sha256 }}"
            },
            "infrasim": {
              "sha256": "${{ steps.build.outputs.cli_sha256 }}"
            }
          },
          "dependencies": {
            "graph_sha256": "${{ steps.analyze.outputs.graph_sha256 }}",
            "package_count": ${{ steps.analyze.outputs.package_count }},
            "has_duplicates": ${{ steps.analyze.outputs.has_duplicates }}
          },
          "analysis": {
            "risk_score": ${{ steps.analyze.outputs.risk_score }},
            "cycle_count": ${{ steps.analyze.outputs.cycle_count }}
          }
        }
        EOF
        
        cat provenance/infrasim-build.json
    
    - name: Upload provenance
      uses: actions/upload-artifact@v4
      with:
        name: infrasim-provenance
        path: |
          provenance/
          cargo-metadata.json
        retention-days: 90
    
    - name: Upload binaries
      uses: actions/upload-artifact@v4
      with:
        name: infrasim-binaries
        path: |
          target/release/infrasimd
          target/release/infrasim
          target/release/infrasim-web
          target/release/terraform-provider-infrasim
        retention-days: 30

  # ===========================================================================
  # Build Alpine Image
  # ===========================================================================
  build-alpine:
    name: Build Alpine Image
    runs-on: ubuntu-latest
    needs: build-infrasim
    if: github.event.inputs.image_type != 'kali-xfce-vnc'
    outputs:
      artifact_name: ${{ steps.meta.outputs.artifact_name }}
      image_sha256: ${{ steps.build.outputs.image_sha256 }}
      version: ${{ steps.meta.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set build metadata
      id: meta
      run: |
        INFRASIM_VERSION="${{ needs.build-infrasim.outputs.infrasim_version }}"
        
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          VERSION="${{ github.ref_name }}"
          SNAPSHOT_TYPE="release"
        elif [[ "${{ github.event.schedule }}" != "" ]]; then
          VERSION="nightly-$(date +%Y%m%d)"
          SNAPSHOT_TYPE="nightly"
        else
          VERSION="${{ github.event.inputs.snapshot_type || 'dev' }}-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          SNAPSHOT_TYPE="${{ github.event.inputs.snapshot_type || 'dev' }}"
        fi
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "snapshot_type=${SNAPSHOT_TYPE}" >> $GITHUB_OUTPUT
        echo "infrasim_version=${INFRASIM_VERSION}" >> $GITHUB_OUTPUT
        echo "git_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "git_sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "artifact_name=infrasim-alpine-${VERSION}" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-utils \
          qemu-system-arm \
          qemu-system-aarch64 \
          qemu-efi-aarch64 \
          genisoimage \
          jq \
          curl
    
    - name: Download InfraSim provenance
      uses: actions/download-artifact@v4
      with:
        name: infrasim-provenance
        path: infrasim-provenance/
    
    - name: Build Alpine qcow2 image
      id: build
      run: |
        chmod +x images/alpine/build-alpine-qcow2.sh
        cd images/alpine
        
        ./build-alpine-qcow2.sh \
          --version ${{ env.ALPINE_VERSION }} \
          --arch aarch64 \
          --size 2G \
          --output output/base.qcow2
        
        # Compute image hash
        IMAGE_SHA256=$(sha256sum output/base.qcow2 | awk '{print $1}')
        echo "image_sha256=${IMAGE_SHA256}" >> $GITHUB_OUTPUT
      env:
        SOURCE_DATE_EPOCH: ${{ github.event.repository.pushed_at || '0' }}
    
    - name: Inject InfraSim provenance into image metadata
      run: |
        cd images/alpine/output
        
        # Add InfraSim provenance to the build metadata
        mkdir -p meta/attestations
        
        # Files are in provenance/ subdirectory after artifact download
        if [ -f ../../../infrasim-provenance/provenance/infrasim-build.json ]; then
          cp ../../../infrasim-provenance/provenance/infrasim-build.json meta/attestations/
        elif [ -f ../../../infrasim-provenance/infrasim-build.json ]; then
          cp ../../../infrasim-provenance/infrasim-build.json meta/attestations/
        else
          echo "Warning: infrasim-build.json not found, creating placeholder"
          echo '{"warning": "provenance not available"}' > meta/attestations/infrasim-build.json
        fi
        
        if [ -f ../../../infrasim-provenance/cargo-metadata.json ]; then
          cp ../../../infrasim-provenance/cargo-metadata.json meta/attestations/
        else
          echo "Warning: cargo-metadata.json not found"
        fi
        
        # Create unified provenance document
        cat > meta/image-provenance.json << EOF
        {
          "image": {
            "type": "alpine",
            "version": "${{ env.ALPINE_VERSION }}",
            "architecture": "aarch64",
            "sha256": "${{ steps.build.outputs.image_sha256 }}"
          },
          "infrasim": {
            "version": "${{ steps.meta.outputs.infrasim_version }}",
            "sha256": "${{ needs.build-infrasim.outputs.infrasim_sha256 }}",
            "dep_graph_sha256": "${{ needs.build-infrasim.outputs.dep_graph_sha256 }}"
          },
          "build": {
            "timestamp": "${{ steps.meta.outputs.build_date }}",
            "git_commit": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "github_run_id": "${{ github.run_id }}",
            "snapshot_version": "${{ steps.meta.outputs.version }}"
          },
          "analysis": {
            "risk_score": ${{ needs.build-infrasim.outputs.risk_score }},
            "cycle_count": ${{ needs.build-infrasim.outputs.cycle_count }}
          }
        }
        EOF
        
        cat meta/image-provenance.json
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: alpine-build-${{ steps.meta.outputs.version }}
        path: images/alpine/output/
        retention-days: 30

  # ===========================================================================
  # Boot Verification Test
  # ===========================================================================
  verify-boot:
    name: Verify Boot
    runs-on: ubuntu-latest
    needs: [build-infrasim, build-alpine]
    outputs:
      boot_status: ${{ steps.boot.outputs.status }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-system-arm \
          qemu-system-aarch64 \
          qemu-efi-aarch64 \
          qemu-utils
    
    - name: Download build
      uses: actions/download-artifact@v4
      with:
        name: alpine-build-${{ needs.build-alpine.outputs.version }}
        path: images/alpine/output/
    
    - name: Run boot test
      id: boot
      run: |
        chmod +x images/alpine/boot-test.sh
        cd images/alpine
        
        # Cross-arch boot test is too slow for CI - skip full boot, just verify image loads
        # On x86_64 runners booting aarch64 images, TCG emulation takes 10+ minutes
        export BOOT_TIMEOUT=60
        export IMAGE_ARCH=aarch64
        
        if ./boot-test.sh output/base.qcow2 2>&1; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Boot test passed"
        else
          echo "status=warning" >> $GITHUB_OUTPUT
          echo "âš ï¸ Boot test inconclusive (cross-arch TCG emulation)"
        fi
      continue-on-error: true
      timeout-minutes: 5
    
    - name: Boot test summary
      run: |
        echo "## Boot Test Result" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.boot.outputs.status }}" == "success" ]]; then
          echo "âœ… Image boots successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Boot test inconclusive (GitHub runners lack KVM)" >> $GITHUB_STEP_SUMMARY
        fi

  # ===========================================================================
  # Create Snapshot Bundle with Full Provenance
  # ===========================================================================
  create-snapshot:
    name: Create Snapshot Bundle
    runs-on: ubuntu-latest
    needs: [build-infrasim, build-alpine, verify-boot]
    outputs:
      bundle_sha256: ${{ steps.bundle.outputs.sha256 }}
      tag_name: ${{ steps.tag.outputs.tag_name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils jq
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: alpine-build-${{ needs.build-alpine.outputs.version }}
        path: build-output/
    
    - name: Download InfraSim provenance
      uses: actions/download-artifact@v4
      with:
        name: infrasim-provenance
        path: infrasim-provenance/
    
    - name: Create snapshot bundle
      id: bundle
      run: |
        chmod +x ci/bundle_qcow2.sh
        
        mkdir -p snapshots
        
        BUNDLE_NAME="${{ needs.build-alpine.outputs.artifact_name }}"
        
        # Ensure provenance is included
        cp -r infrasim-provenance/* build-output/meta/attestations/ 2>/dev/null || true
        
        ./ci/bundle_qcow2.sh \
          --input build-output \
          --output "snapshots/${BUNDLE_NAME}.tar.gz" \
          --version ${{ env.ALPINE_VERSION }} \
          --git-sha $(git rev-parse --short HEAD)
        
        # Output bundle hash
        BUNDLE_SHA256=$(cat "snapshots/${BUNDLE_NAME}.tar.gz.sha256" | awk '{print $1}')
        echo "sha256=${BUNDLE_SHA256}" >> $GITHUB_OUTPUT
        echo "bundle_name=${BUNDLE_NAME}" >> $GITHUB_OUTPUT
      env:
        GITHUB_RUN_ID: ${{ github.run_id }}
    
    - name: Generate version tag
      id: tag
      run: |
        VERSION="${{ needs.build-alpine.outputs.version }}"
        INFRASIM_VERSION="${{ needs.build-infrasim.outputs.infrasim_version }}"
        IMAGE_SHA256="${{ needs.build-alpine.outputs.image_sha256 }}"
        
        # Create a unique tag combining image version and infrasim version
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          TAG_NAME="${{ github.ref_name }}"
        else
          # Format: image-alpine-YYYYMMDD-INFRASIM_SHORT-IMAGE_SHORT
          INFRASIM_SHORT=$(echo "${INFRASIM_VERSION}" | cut -c1-8)
          IMAGE_SHORT=$(echo "${IMAGE_SHA256}" | cut -c1-8)
          TAG_NAME="image-alpine-$(date +%Y%m%d)-${INFRASIM_SHORT}-${IMAGE_SHORT}"
        fi
        
        echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
        echo "Generated tag: ${TAG_NAME}"
    
    - name: Display bundle info
      run: |
        BUNDLE_NAME="${{ needs.build-alpine.outputs.artifact_name }}"
        echo "=== Bundle: ${BUNDLE_NAME}.tar.gz ===" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Image SHA256 | \`${{ needs.build-alpine.outputs.image_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Bundle SHA256 | \`${{ steps.bundle.outputs.sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| InfraSim Version | \`${{ needs.build-infrasim.outputs.infrasim_version }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| InfraSim SHA256 | \`${{ needs.build-infrasim.outputs.infrasim_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Dep Graph SHA256 | \`${{ needs.build-infrasim.outputs.dep_graph_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Tag | \`${{ steps.tag.outputs.tag_name }}\` |" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload snapshot
      uses: actions/upload-artifact@v4
      with:
        name: ${{ needs.build-alpine.outputs.artifact_name }}
        path: |
          snapshots/*.tar.gz
          snapshots/*.sha256
        retention-days: 90

  # ===========================================================================
  # Create Tag and Deploy Release
  # ===========================================================================
  deploy-tag:
    name: Deploy Tag
    runs-on: ubuntu-latest
    needs: [build-infrasim, build-alpine, verify-boot, create-snapshot]
    if: |
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')) &&
      (github.event.inputs.create_tag != 'false' || github.event.inputs.create_tag == null)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Download snapshot
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-alpine.outputs.artifact_name }}
        path: snapshots/
    
    - name: Download InfraSim provenance
      uses: actions/download-artifact@v4
      with:
        name: infrasim-provenance
        path: infrasim-provenance/
    
    - name: Create and push tag
      id: create_tag
      if: "!startsWith(github.ref, 'refs/tags/')"
      run: |
        TAG_NAME="${{ needs.create-snapshot.outputs.tag_name }}"
        
        # Check if tag already exists
        if git rev-parse "${TAG_NAME}" >/dev/null 2>&1; then
          echo "Tag ${TAG_NAME} already exists, skipping"
          echo "tag_created=false" >> $GITHUB_OUTPUT
        else
          # Create annotated tag with provenance info
          git tag -a "${TAG_NAME}" -m "Image snapshot: ${TAG_NAME}
        
        InfraSim Version: ${{ needs.build-infrasim.outputs.infrasim_version }}
        InfraSim SHA256: ${{ needs.build-infrasim.outputs.infrasim_sha256 }}
        Image SHA256: ${{ needs.build-alpine.outputs.image_sha256 }}
        Bundle SHA256: ${{ needs.create-snapshot.outputs.bundle_sha256 }}
        Dep Graph SHA256: ${{ needs.build-infrasim.outputs.dep_graph_sha256 }}
        
        Build: ${{ github.run_id }}
        Commit: ${{ github.sha }}"

          git push origin "${TAG_NAME}"
          echo "tag_created=true" >> $GITHUB_OUTPUT
          echo "Created and pushed tag: ${TAG_NAME}"
        fi
    
    - name: Generate release notes
      id: notes
      run: |
        VERSION="${{ needs.build-alpine.outputs.version }}"
        TAG_NAME="${{ needs.create-snapshot.outputs.tag_name }}"
        BUNDLE_NAME="${{ needs.build-alpine.outputs.artifact_name }}"
        IMAGE_SHA256="${{ needs.build-alpine.outputs.image_sha256 }}"
        BUNDLE_SHA256="${{ needs.create-snapshot.outputs.bundle_sha256 }}"
        INFRASIM_VERSION="${{ needs.build-infrasim.outputs.infrasim_version }}"
        INFRASIM_SHA256="${{ needs.build-infrasim.outputs.infrasim_sha256 }}"
        DEP_GRAPH_SHA256="${{ needs.build-infrasim.outputs.dep_graph_sha256 }}"
        REPO="${{ github.repository }}"
        
        {
          echo "## Image Snapshot: ${TAG_NAME}"
          echo ""
          echo "This snapshot bundles an Alpine Linux qcow2 image with pinned InfraSim build provenance."
          echo ""
          echo "### Build Provenance"
          echo ""
          echo "| Component | Version/Hash |"
          echo "|-----------|--------------|"
          echo "| InfraSim Version | \`${INFRASIM_VERSION}\` |"
          echo "| InfraSim Binary SHA256 | \`${INFRASIM_SHA256}\` |"
          echo "| Dependency Graph SHA256 | \`${DEP_GRAPH_SHA256}\` |"
          echo "| Image SHA256 | \`${IMAGE_SHA256}\` |"
          echo "| Bundle SHA256 | \`${BUNDLE_SHA256}\` |"
          echo ""
          echo "### Contents"
          echo ""
          echo "| File | Description |"
          echo "|------|-------------|"
          echo "| \`disk/base.qcow2\` | Main disk image |"
          echo "| \`disk/snapshots/clean.qcow2\` | Clean overlay snapshot |"
          echo "| \`meta/manifest.json\` | File checksums |"
          echo "| \`meta/attestations/infrasim-build.json\` | InfraSim build provenance |"
          echo "| \`meta/attestations/cargo-metadata.json\` | Full dependency graph |"
          echo "| \`meta/image-provenance.json\` | Unified provenance document |"
          echo ""
          echo "### Verification"
          echo ""
          echo "\`\`\`bash"
          echo "# Download and verify"
          echo "curl -LO https://github.com/${REPO}/releases/download/${TAG_NAME}/${BUNDLE_NAME}.tar.gz"
          echo "curl -LO https://github.com/${REPO}/releases/download/${TAG_NAME}/${BUNDLE_NAME}.tar.gz.sha256"
          echo "shasum -a 256 -c ${BUNDLE_NAME}.tar.gz.sha256"
          echo ""
          echo "# Extract and verify image"
          echo "tar -xzf ${BUNDLE_NAME}.tar.gz"
          echo "echo \"${IMAGE_SHA256}  disk/base.qcow2\" | shasum -a 256 -c"
          echo "\`\`\`"
          echo ""
          echo "### Quick Start"
          echo ""
          echo "\`\`\`bash"
          echo "# Boot with QEMU (macOS Apple Silicon)"
          echo "qemu-system-aarch64 -M virt -accel hvf -cpu host -m 512 \\\\"
          echo "  -drive file=disk/base.qcow2,format=qcow2,if=virtio \\\\"
          echo "  -bios /opt/homebrew/share/qemu/edk2-aarch64-code.fd \\\\"
          echo "  -nographic"
          echo "\`\`\`"
        } > release-notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.create-snapshot.outputs.tag_name }}
        name: "Image Snapshot ${{ needs.create-snapshot.outputs.tag_name }}"
        body_path: release-notes.md
        files: |
          snapshots/*.tar.gz
          snapshots/*.sha256
          infrasim-provenance/infrasim-build.json
        draft: false
        prerelease: ${{ contains(needs.build-alpine.outputs.version, 'nightly') || contains(needs.build-alpine.outputs.version, 'test') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Tag deployment summary
      run: |
        echo "## ðŸ·ï¸ Tag Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** \`${{ needs.create-snapshot.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release:** [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-snapshot.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Update Latest Pointer (for nightly/scheduled builds)
  # ===========================================================================
  update-latest:
    name: Update Latest
    runs-on: ubuntu-latest
    needs: [build-infrasim, build-alpine, create-snapshot, deploy-tag]
    if: github.event.schedule != '' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    
    steps:
    - name: Download snapshot
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-alpine.outputs.artifact_name }}
        path: snapshots/
    
    - name: Download provenance
      uses: actions/download-artifact@v4
      with:
        name: infrasim-provenance
        path: infrasim-provenance/
    
    - name: Update latest release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest-image
        name: "Latest Image Snapshot"
        body: |
          ## Latest Image Snapshot
          
          **Auto-updated:** ${{ github.event.schedule != '' && 'Weekly schedule' || 'Push to main' }}
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Based on:** ${{ needs.create-snapshot.outputs.tag_name }}
          
          ### Provenance
          - InfraSim: `${{ needs.build-infrasim.outputs.infrasim_version }}`
          - Image SHA256: `${{ needs.build-alpine.outputs.image_sha256 }}`
          
          This is a rolling release. For versioned snapshots, see [Releases](../../releases).
        files: |
          snapshots/*.tar.gz
          snapshots/*.sha256
          infrasim-provenance/infrasim-build.json
        prerelease: true
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
