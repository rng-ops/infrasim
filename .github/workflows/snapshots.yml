# ============================================================================
# snapshots.yml - Build and Publish Image Snapshots
# ============================================================================
#
# Creates versioned qcow2 image snapshots and publishes them as GitHub releases.
#
# Triggers:
# - Tag push (v*) - Creates a release with the image bundle
# - Weekly schedule - Creates a rolling "latest" snapshot
# - Manual dispatch - For testing/ad-hoc builds
#
name: Snapshots

on:
  push:
    tags:
      - 'v*'
  schedule:
    # Every Sunday at 2 AM UTC - rolling weekly snapshot
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      snapshot_type:
        description: 'Snapshot type'
        type: choice
        options:
          - release
          - nightly
          - test
        default: test
      alpine_version:
        description: 'Alpine version'
        default: '3.20'

env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}

jobs:
  # ===========================================================================
  # Build Alpine qcow2 Image
  # ===========================================================================
  build-image:
    name: Build Alpine Image
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ steps.meta.outputs.artifact_name }}
      image_sha256: ${{ steps.build.outputs.image_sha256 }}
      version: ${{ steps.meta.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set build metadata
      id: meta
      run: |
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          VERSION="${{ github.ref_name }}"
          SNAPSHOT_TYPE="release"
        elif [[ "${{ github.event.schedule }}" != "" ]]; then
          VERSION="nightly-$(date +%Y%m%d)"
          SNAPSHOT_TYPE="nightly"
        else
          VERSION="${{ github.event.inputs.snapshot_type }}-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          SNAPSHOT_TYPE="${{ github.event.inputs.snapshot_type }}"
        fi
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "snapshot_type=${SNAPSHOT_TYPE}" >> $GITHUB_OUTPUT
        echo "git_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "git_sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "artifact_name=infrasim-alpine-${VERSION}" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-utils \
          qemu-system-arm \
          qemu-system-aarch64 \
          qemu-efi-aarch64 \
          genisoimage \
          jq \
          curl
    
    - name: Build Alpine qcow2 image
      id: build
      run: |
        chmod +x images/alpine/build-alpine-qcow2.sh
        cd images/alpine
        
        ./build-alpine-qcow2.sh \
          --version ${{ env.ALPINE_VERSION }} \
          --arch aarch64 \
          --size 2G \
          --output output/base.qcow2
        
        # Compute image hash
        IMAGE_SHA256=$(sha256sum output/base.qcow2 | awk '{print $1}')
        echo "image_sha256=${IMAGE_SHA256}" >> $GITHUB_OUTPUT
      env:
        SOURCE_DATE_EPOCH: ${{ github.event.repository.pushed_at || '0' }}
    
    - name: Display build info
      run: |
        echo "=== Build Output ==="
        ls -la images/alpine/output/
        echo ""
        echo "=== qemu-img info ==="
        qemu-img info images/alpine/output/base.qcow2
        echo ""
        echo "=== Provenance ==="
        cat images/alpine/output/meta/build-provenance.json
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: alpine-build-${{ steps.meta.outputs.version }}
        path: images/alpine/output/
        retention-days: 30

  # ===========================================================================
  # Boot Verification Test
  # ===========================================================================
  verify-boot:
    name: Verify Boot
    runs-on: ubuntu-latest
    needs: build-image
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-system-arm \
          qemu-system-aarch64 \
          qemu-efi-aarch64 \
          qemu-utils
    
    - name: Download build
      uses: actions/download-artifact@v4
      with:
        name: alpine-build-${{ needs.build-image.outputs.version }}
        path: images/alpine/output/
    
    - name: Run boot test
      id: boot
      run: |
        chmod +x images/alpine/boot-test.sh
        cd images/alpine
        
        # Cross-arch boot test is too slow for CI - use shorter timeout
        export BOOT_TIMEOUT=60
        export IMAGE_ARCH=aarch64
        
        if ./boot-test.sh output/base.qcow2 2>&1; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=warning" >> $GITHUB_OUTPUT
          echo "::warning::Boot test did not complete (cross-arch TCG emulation is slow)"
        fi
      continue-on-error: true
      timeout-minutes: 5
    
    - name: Boot test result
      run: |
        echo "## Boot Test" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.boot.outputs.status }}" == "success" ]]; then
          echo "✅ Image boots successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Boot test inconclusive (no KVM in GitHub runners)" >> $GITHUB_STEP_SUMMARY
        fi

  # ===========================================================================
  # Create Snapshot Bundle
  # ===========================================================================
  create-snapshot:
    name: Create Snapshot Bundle
    runs-on: ubuntu-latest
    needs: [build-image, verify-boot]
    outputs:
      bundle_sha256: ${{ steps.bundle.outputs.sha256 }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils jq
    
    - name: Download build
      uses: actions/download-artifact@v4
      with:
        name: alpine-build-${{ needs.build-image.outputs.version }}
        path: build-output/
    
    - name: Create snapshot bundle
      id: bundle
      run: |
        chmod +x ci/bundle_qcow2.sh
        
        mkdir -p snapshots
        
        BUNDLE_NAME="${{ needs.build-image.outputs.artifact_name }}"
        
        ./ci/bundle_qcow2.sh \
          --input build-output \
          --output "snapshots/${BUNDLE_NAME}.tar.gz" \
          --version ${{ env.ALPINE_VERSION }} \
          --git-sha $(git rev-parse --short HEAD)
        
        # Output bundle hash
        BUNDLE_SHA256=$(cat "snapshots/${BUNDLE_NAME}.tar.gz.sha256" | awk '{print $1}')
        echo "sha256=${BUNDLE_SHA256}" >> $GITHUB_OUTPUT
        echo "bundle_name=${BUNDLE_NAME}" >> $GITHUB_OUTPUT
      env:
        GITHUB_RUN_ID: ${{ github.run_id }}
    
    - name: Display bundle contents
      run: |
        BUNDLE_NAME="${{ needs.build-image.outputs.artifact_name }}"
        echo "=== Bundle: ${BUNDLE_NAME}.tar.gz ==="
        ls -lh snapshots/
        echo ""
        echo "=== Contents ==="
        tar -tzvf "snapshots/${BUNDLE_NAME}.tar.gz"
        echo ""
        echo "=== Manifest ==="
        tar -xzf "snapshots/${BUNDLE_NAME}.tar.gz" -O meta/manifest.json | jq .
    
    - name: Upload snapshot
      uses: actions/upload-artifact@v4
      with:
        name: ${{ needs.build-image.outputs.artifact_name }}
        path: |
          snapshots/*.tar.gz
          snapshots/*.sha256
        retention-days: 90

  # ===========================================================================
  # Publish Release (on tag)
  # ===========================================================================
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build-image, create-snapshot]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download snapshot
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-image.outputs.artifact_name }}
        path: snapshots/
    
    - name: Generate release notes
      id: notes
      run: |
        VERSION="${{ needs.build-image.outputs.version }}"
        BUNDLE_NAME="${{ needs.build-image.outputs.artifact_name }}"
        IMAGE_SHA256="${{ needs.build-image.outputs.image_sha256 }}"
        BUNDLE_SHA256="${{ needs.create-snapshot.outputs.bundle_sha256 }}"
        
        cat > release-notes.md << EOF
        ## InfraSim Alpine Image ${VERSION}
        
        This release contains a QEMU-bootable Alpine Linux qcow2 image for aarch64.
        
        ### Contents
        
        | File | Description |
        |------|-------------|
        | \`disk/base.qcow2\` | Main disk image (Alpine ${ALPINE_VERSION}) |
        | \`disk/snapshots/clean.qcow2\` | Clean overlay snapshot |
        | \`meta/manifest.json\` | File checksums |
        | \`meta/attestations/\` | Build provenance |
        
        ### Checksums
        
        \`\`\`
        # Bundle
        ${BUNDLE_SHA256}  ${BUNDLE_NAME}.tar.gz
        
        # Image
        ${IMAGE_SHA256}  disk/base.qcow2
        \`\`\`
        
        ### Verification
        
        \`\`\`bash
        # Download
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/${BUNDLE_NAME}.tar.gz
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/${BUNDLE_NAME}.tar.gz.sha256
        
        # Verify
        shasum -a 256 -c ${BUNDLE_NAME}.tar.gz.sha256
        
        # Extract
        tar -xzf ${BUNDLE_NAME}.tar.gz
        
        # Boot (macOS Apple Silicon)
        qemu-system-aarch64 -M virt -accel hvf -cpu host -m 512 \\
          -drive file=disk/base.qcow2,format=qcow2,if=virtio \\
          -bios /opt/homebrew/share/qemu/edk2-aarch64-code.fd \\
          -nographic
        \`\`\`
        
        ### Use with Terraform
        
        \`\`\`hcl
        resource "infrasim_vm" "alpine" {
          name   = "alpine-runner"
          cpus   = 2
          memory = 512
          disk   = "/path/to/disk/base.qcow2"
        }
        \`\`\`
        
        ---
        
        **Build Info:**
        - Alpine Version: ${ALPINE_VERSION}
        - Architecture: aarch64
        - Git SHA: $(git rev-parse --short HEAD)
        - Build Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: "Alpine Image ${{ needs.build-image.outputs.version }}"
        body_path: release-notes.md
        files: |
          snapshots/*.tar.gz
          snapshots/*.sha256
        draft: false
        prerelease: ${{ contains(needs.build-image.outputs.version, 'nightly') || contains(needs.build-image.outputs.version, 'test') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Update Latest (on schedule or main push)
  # ===========================================================================
  update-latest:
    name: Update Latest Snapshot
    runs-on: ubuntu-latest
    needs: [build-image, create-snapshot]
    if: github.event.schedule != '' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    
    steps:
    - name: Download snapshot
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-image.outputs.artifact_name }}
        path: snapshots/
    
    - name: Update latest release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: "Latest Alpine Snapshot"
        body: |
          ## Latest Alpine Image Snapshot
          
          **Auto-updated:** ${{ github.event.schedule != '' && 'Weekly schedule' || 'Push to main' }}
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Based on:** ${{ needs.build-image.outputs.version }}
          
          This is a rolling release that tracks the latest stable image.
          For versioned releases, see the [Releases](../../releases) page.
        files: |
          snapshots/*.tar.gz
          snapshots/*.sha256
        prerelease: true
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
