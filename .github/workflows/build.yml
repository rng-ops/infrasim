name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build on macOS ARM64
    runs-on: macos-14  # M1 runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin
    
    - name: Install protobuf
      run: |
        brew install protobuf
        protoc --version
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: ICMP Timing Probes (Pre-Build)
      id: timing_pre
      run: |
        echo "=== Network Timing Fingerprint (Pre-Build) ===" | tee timing-pre.txt
        echo "timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a timing-pre.txt
        echo "github_run_id: ${{ github.run_id }}" | tee -a timing-pre.txt
        echo "" | tee -a timing-pre.txt
        
        # Probe time servers for BGP path inference
        for host in time.google.com time.cloudflare.com time.apple.com time.nist.gov pool.ntp.org; do
          echo "Probing $host..." | tee -a timing-pre.txt
          ping -c 3 -W 2 $host 2>&1 | tail -1 | tee -a timing-pre.txt || echo "  Failed" | tee -a timing-pre.txt
        done
        
        # Geographic reference probes
        echo "" | tee -a timing-pre.txt
        echo "=== Geographic References ===" | tee -a timing-pre.txt
        for host in ping.online.net speedtest.tele2.net; do
          echo "Probing $host..." | tee -a timing-pre.txt
          ping -c 3 -W 2 $host 2>&1 | tail -1 | tee -a timing-pre.txt || echo "  Failed" | tee -a timing-pre.txt
        done
    
    - name: Run build pipeline
      run: |
        chmod +x build.sh
        ./build.sh
      env:
        VERSION: ${{ github.ref_name }}
    
    - name: Run tests
      run: cargo test --all --verbose
    
    - name: ICMP Timing Probes (Post-Build)
      id: timing_post
      run: |
        echo "=== Network Timing Fingerprint (Post-Build) ===" | tee timing-post.txt
        echo "timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a timing-post.txt
        echo "" | tee -a timing-post.txt
        
        for host in time.google.com time.cloudflare.com time.apple.com; do
          echo "Probing $host..." | tee -a timing-post.txt
          ping -c 3 -W 2 $host 2>&1 | tail -1 | tee -a timing-post.txt || echo "  Failed" | tee -a timing-post.txt
        done
    
    - name: Setup ISVM
      run: |
        # Install ISVM for version management
        chmod +x scripts/install-isvm.sh
        ./scripts/install-isvm.sh
        
        # Source ISVM functions
        export ISVM_DIR="$HOME/.isvm"
        source "$ISVM_DIR/isvm.sh"
        
        # Install this build version
        make isvm-install
        
        # List installed versions
        isvm list
    
    - name: Create version metadata
      run: |
        mkdir -p dist
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "${{ github.ref_name }}")
        cat > dist/version-metadata.json << EOF
        {
          "version": "$VERSION",
          "git_commit": "${{ github.sha }}",
          "git_branch": "${{ github.ref_name }}",
          "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "github_run_id": "${{ github.run_id }}",
          "github_run_number": "${{ github.run_number }}",
          "runner_os": "${{ runner.os }}",
          "runner_arch": "${{ runner.arch }}",
          "isvm_compatible": true
        }
        EOF
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: infrasim-${{ github.ref_name }}-aarch64-apple-darwin
        path: |
          dist/*.tar.gz
          dist/*.sha256
          dist/manifest.json
          dist/version-metadata.json
          timing-pre.txt
          timing-post.txt
        retention-days: 30
    
    - name: Upload ISVM metadata
      uses: actions/upload-artifact@v4
      with:
        name: isvm-metadata-${{ github.ref_name }}
        path: |
          dist/version-metadata.json
        retention-days: 90
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.tar.gz
          dist/*.sha256
          dist/manifest.json
          dist/version-metadata.json
          timing-pre.txt
          timing-post.txt
        body: |
          ## InfraSim Release ${{ github.ref_name }}
          
          ### Binaries
          - `infrasim` - CLI tool
          - `infrasimd` - Daemon
          - `infrasim-web` - Web console
          - `terraform-provider-infrasim` - Terraform provider
          
          ### Installation with ISVM (Recommended)
          ```bash
          # Install ISVM version manager
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install-isvm.sh | bash
          
          # Install this version
          isvm install ${{ github.ref_name }}
          isvm use ${{ github.ref_name }}
          
          # Verify
          infrasim --version
          ```
          
          ### Manual Installation
          ```bash
          # Download and extract
          tar -xzf infrasim-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz
          
          # Move to PATH
          sudo mv infrasim infrasimd infrasim-web /usr/local/bin/
          
          # Terraform provider
          mkdir -p ~/.terraform.d/plugins/registry.terraform.io/infrasim/infrasim/${{ github.ref_name }}/darwin_arm64
          mv terraform-provider-infrasim ~/.terraform.d/plugins/registry.terraform.io/infrasim/infrasim/${{ github.ref_name }}/darwin_arm64/
          ```
          
          ### Requirements
          - macOS 12+ (Apple Silicon)
          - QEMU 8.0+ (`brew install qemu`)
          
          ### Build Provenance
          - Commit: ${{ github.sha }}
          - Run ID: ${{ github.run_id }}
          - Timing probes included for network path analysis
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build Docker Image (experimental)
    runs-on: macos-14
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/arm64
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/daemon:latest
          ghcr.io/${{ github.repository }}/daemon:${{ github.ref_name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
