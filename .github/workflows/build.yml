name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build on macOS ARM64
    runs-on: macos-14  # M1 runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin
    
    - name: Install protobuf
      run: |
        brew install protobuf
        protoc --version
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Run build pipeline
      run: |
        chmod +x build.sh
        ./build.sh
      env:
        VERSION: ${{ github.ref_name }}
    
    - name: Run tests
      run: cargo test --all --verbose
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: infrasim-${{ github.ref_name }}-aarch64-apple-darwin
        path: |
          dist/*.tar.gz
          dist/*.sha256
          dist/manifest.json
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.tar.gz
          dist/*.sha256
          dist/manifest.json
        body: |
          ## InfraSim Release ${{ github.ref_name }}
          
          ### Binaries
          - `infrasim` - CLI tool
          - `infrasimd` - Daemon
          - `terraform-provider-infrasim` - Terraform provider
          
          ### Installation
          ```bash
          # Download and extract
          tar -xzf infrasim-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz
          
          # Move to PATH
          sudo mv infrasim /usr/local/bin/
          sudo mv infrasimd /usr/local/bin/
          
          # Terraform provider
          mkdir -p ~/.terraform.d/plugins/registry.terraform.io/infrasim/infrasim/${{ github.ref_name }}/darwin_arm64
          mv terraform-provider-infrasim ~/.terraform.d/plugins/registry.terraform.io/infrasim/infrasim/${{ github.ref_name }}/darwin_arm64/
          ```
          
          ### Requirements
          - macOS 12+ (Apple Silicon)
          - QEMU 8.0+ (`brew install qemu`)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build Docker Image (experimental)
    runs-on: macos-14
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/arm64
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/daemon:latest
          ghcr.io/${{ github.repository }}/daemon:${{ github.ref_name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
